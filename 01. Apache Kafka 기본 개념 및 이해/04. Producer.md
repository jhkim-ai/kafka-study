b# 04. Producer

## 1. Apache Kafka Clients

### 1) Producer, Consumer, Consumer Group

- `Producer` : 메시지를 생산(Producer)하여 Kafka의 Topic으로 전송하는 Application
- `Consumer` : Topic의 메시지를 가져와(Consumer) 사용하는 Application
- `Consumer Group` : Topic의 메시지를 사용하기 위해 협력하는 Consumer들의 집함
- 하나의 `Consumer`는 하나의 `Consumer Group`에 포함되며, `Consumer Group`내의 `Consumer`들은 협력하여 Topic의 메시지를 병렬 처리

### 2) Producer와 Consumer의 기본 동장 방식

![Producer & Consumer 기본 동작](../img/part1/04_01_Producer와Consumer_기본동작.PNG "Producer & Consumer 기본 동작")

- Producer와 Consumer는 서로 알지 못함
- Producer와 Consumer는 각각 고유의 속도로 Commit Log에 Write/Read 수행
- 다른 Consumer Group에 속한 Consumer 들은 서로 관련 없으며, Commit Log에 있는 Event(Message)를 동시에 다른 위치에서 Read할 수 있음

</br>

---

</br>

## 2. Record(Message) 구조

> Message == Record == Event == Data

<br/>

![Record 구조](../img/part1/04_02_Recode구조.PNG "Record 구조")

- Message 는 `Header`, `Key`, `Value` 구조를 가짐
- `Header`는 Metadata(Topic, Partition, Timestamp, etc)를 가짐
- `Key`, `value`는 비즈니스 데이터를 가짐
  - `Avro`, `JSON`, `String` 등 다양한 형태로 가능

</br>

---

</br>

## 3. Kafka는 Record(data)를 Byte Array로 저장

![ByteArray로 저장](../img/part1/04_03_ByteArray저장.PNG "ByteArray로 저장")

- `Producer`는 `JSON`, `String`, `Avro`, `Protobuf` 등의 데이터를 `Serialization(직렬화)`하여 Byte Array로 전환(저장)
- `Consumer`는 Byte Array를 `Deserialization(역직렬화)`하여 `JSON`, `String`, `Avro`, `Protobuf` 등의 데이터로 전환하여 사용

</br>

---

</br>

## 4. Producing to Kafka

</br>

![Producer 작동 과정](../img/part1/04_04_Producer작동과정.PNG "Producer 작동 과정")

- Producer Application에서 `send()`메서드만 호출하면 뒤의 과정들은 `Kafka`가 알아서 한다.

</br>

---

</br>

## 5. Partitioner

> - Topic의 메시지를 어떤 Partition으로 보낼지 결정하는 알고리즘
> - Key의 존재 여부에 따라 알고리즘이 다름

</br>

### 1) Key가 Null이 아닐 때의 Default Partitioner

</br>

![Key가 Null이 아닐 때의 Default Partitioner](../img/part1/04_05_Default_Partitioner_Not_null.PNG "Key가 Null이 아닐 때의 Default Partitioner")

- `Partitioner`의 `default` 알고리즘은 `Key` 값의 `Hashing` 및 `mod` 연산을 통해 어떤 `Partition`으로 보낼지 결정 한다.
- `Partitioner`의 알고리즘은 `Customizing` 할 수 있다.
- 전제 조건은 `Key`가 `null`이 아니어야 한다.

</br>

### 2) Key가 Null일 때의 Default Partitioner

</br>

![Key가 Null일 때의 Default Partitioner](../img/part1/04_06_Default_Partitioner_null.PNG "Key가 Null일 때의 Default Partitioner")

- `Key`가 `Null`일 경우, Kafka 2.4 이전의 Default Partitioner의 정책은 Round Robin 방식으로 동작
  - 그러나, Batch 형태의 메시지로 보낼 때 메시지가 다 담겨지기 전에 보내지는 현상이 발생하여 Kafka 2.4 이후부턴 하나의 Batch가 닫힐 때까지 Partition을 채운 후 전송한다.
- `Partitioner`의 알고리즘은 `Customizing` 할 수 있다.
